{
  "id": "002_serverless_api",
  "source": "AWS Solutions Library - Serverless API",
  "request": "サーバーレスでREST APIを構築したい。API GatewayとLambdaを使い、データはDynamoDBに保存する構成で。",
  "terraform_files": {
    "main_tf": "# DynamoDB Table\nresource \"aws_dynamodb_table\" \"main\" {\n  name           = \"${var.project_name}-table\"\n  billing_mode   = \"PAY_PER_REQUEST\"\n  hash_key       = \"id\"\n\n  attribute {\n    name = \"id\"\n    type = \"S\"\n  }\n\n  tags = {\n    Name = \"${var.project_name}-table\"\n  }\n}\n\n# Lambda IAM Role\nresource \"aws_iam_role\" \"lambda\" {\n  name = \"${var.project_name}-lambda-role\"\n\n  assume_role_policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Action = \"sts:AssumeRole\"\n        Effect = \"Allow\"\n        Principal = {\n          Service = \"lambda.amazonaws.com\"\n        }\n      }\n    ]\n  })\n\n  tags = {\n    Name = \"${var.project_name}-lambda-role\"\n  }\n}\n\nresource \"aws_iam_role_policy\" \"lambda_dynamodb\" {\n  name = \"${var.project_name}-lambda-dynamodb-policy\"\n  role = aws_iam_role.lambda.id\n\n  policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Effect = \"Allow\"\n        Action = [\n          \"dynamodb:GetItem\",\n          \"dynamodb:PutItem\",\n          \"dynamodb:UpdateItem\",\n          \"dynamodb:DeleteItem\",\n          \"dynamodb:Scan\",\n          \"dynamodb:Query\"\n        ]\n        Resource = aws_dynamodb_table.main.arn\n      }\n    ]\n  })\n}\n\nresource \"aws_iam_role_policy_attachment\" \"lambda_basic\" {\n  role       = aws_iam_role.lambda.name\n  policy_arn = \"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole\"\n}\n\n# Lambda Function\nresource \"aws_lambda_function\" \"api\" {\n  filename         = data.archive_file.lambda.output_path\n  function_name    = \"${var.project_name}-api\"\n  role             = aws_iam_role.lambda.arn\n  handler          = \"index.handler\"\n  source_code_hash = data.archive_file.lambda.output_base64sha256\n  runtime          = \"nodejs18.x\"\n  timeout          = 30\n  memory_size      = 256\n\n  environment {\n    variables = {\n      TABLE_NAME = aws_dynamodb_table.main.name\n    }\n  }\n\n  tags = {\n    Name = \"${var.project_name}-api\"\n  }\n}\n\n# Lambda source code\ndata \"archive_file\" \"lambda\" {\n  type        = \"zip\"\n  output_path = \"${path.module}/lambda.zip\"\n\n  source {\n    content  = <<-EOF\n      exports.handler = async (event) => {\n        const response = {\n          statusCode: 200,\n          headers: {\n            'Content-Type': 'application/json'\n          },\n          body: JSON.stringify({ message: 'Hello from Lambda!' })\n        };\n        return response;\n      };\n    EOF\n    filename = \"index.js\"\n  }\n}\n\n# API Gateway\nresource \"aws_apigatewayv2_api\" \"main\" {\n  name          = \"${var.project_name}-api\"\n  protocol_type = \"HTTP\"\n\n  cors_configuration {\n    allow_headers = [\"*\"]\n    allow_methods = [\"GET\", \"POST\", \"PUT\", \"DELETE\", \"OPTIONS\"]\n    allow_origins = [\"*\"]\n  }\n\n  tags = {\n    Name = \"${var.project_name}-api\"\n  }\n}\n\nresource \"aws_apigatewayv2_stage\" \"main\" {\n  api_id      = aws_apigatewayv2_api.main.id\n  name        = var.api_stage\n  auto_deploy = true\n\n  access_log_settings {\n    destination_arn = aws_cloudwatch_log_group.api.arn\n    format = jsonencode({\n      requestId      = \"$context.requestId\"\n      ip             = \"$context.identity.sourceIp\"\n      requestTime    = \"$context.requestTime\"\n      httpMethod     = \"$context.httpMethod\"\n      routeKey       = \"$context.routeKey\"\n      status         = \"$context.status\"\n      responseLength = \"$context.responseLength\"\n    })\n  }\n\n  tags = {\n    Name = \"${var.project_name}-api-stage\"\n  }\n}\n\nresource \"aws_apigatewayv2_integration\" \"lambda\" {\n  api_id                 = aws_apigatewayv2_api.main.id\n  integration_type       = \"AWS_PROXY\"\n  integration_uri        = aws_lambda_function.api.invoke_arn\n  payload_format_version = \"2.0\"\n}\n\nresource \"aws_apigatewayv2_route\" \"get\" {\n  api_id    = aws_apigatewayv2_api.main.id\n  route_key = \"GET /items\"\n  target    = \"integrations/${aws_apigatewayv2_integration.lambda.id}\"\n}\n\nresource \"aws_apigatewayv2_route\" \"post\" {\n  api_id    = aws_apigatewayv2_api.main.id\n  route_key = \"POST /items\"\n  target    = \"integrations/${aws_apigatewayv2_integration.lambda.id}\"\n}\n\nresource \"aws_apigatewayv2_route\" \"get_single\" {\n  api_id    = aws_apigatewayv2_api.main.id\n  route_key = \"GET /items/{id}\"\n  target    = \"integrations/${aws_apigatewayv2_integration.lambda.id}\"\n}\n\nresource \"aws_apigatewayv2_route\" \"delete\" {\n  api_id    = aws_apigatewayv2_api.main.id\n  route_key = \"DELETE /items/{id}\"\n  target    = \"integrations/${aws_apigatewayv2_integration.lambda.id}\"\n}\n\n# Lambda Permission for API Gateway\nresource \"aws_lambda_permission\" \"api\" {\n  statement_id  = \"AllowAPIGatewayInvoke\"\n  action        = \"lambda:InvokeFunction\"\n  function_name = aws_lambda_function.api.function_name\n  principal     = \"apigateway.amazonaws.com\"\n  source_arn    = \"${aws_apigatewayv2_api.main.execution_arn}/*/*\"\n}\n\n# CloudWatch Log Group\nresource \"aws_cloudwatch_log_group\" \"api\" {\n  name              = \"/aws/apigateway/${var.project_name}\"\n  retention_in_days = 14\n\n  tags = {\n    Name = \"${var.project_name}-api-logs\"\n  }\n}\n\nresource \"aws_cloudwatch_log_group\" \"lambda\" {\n  name              = \"/aws/lambda/${var.project_name}-api\"\n  retention_in_days = 14\n\n  tags = {\n    Name = \"${var.project_name}-lambda-logs\"\n  }\n}",
    "variables_tf": "variable \"aws_region\" {\n  description = \"AWS region\"\n  type        = string\n  default     = \"ap-northeast-1\"\n}\n\nvariable \"project_name\" {\n  description = \"Project name for resource naming\"\n  type        = string\n  default     = \"serverless-api\"\n}\n\nvariable \"api_stage\" {\n  description = \"API Gateway stage name\"\n  type        = string\n  default     = \"prod\"\n}",
    "outputs_tf": "output \"api_endpoint\" {\n  description = \"API Gateway endpoint URL\"\n  value       = aws_apigatewayv2_stage.main.invoke_url\n}\n\noutput \"dynamodb_table_name\" {\n  description = \"DynamoDB table name\"\n  value       = aws_dynamodb_table.main.name\n}\n\noutput \"lambda_function_name\" {\n  description = \"Lambda function name\"\n  value       = aws_lambda_function.api.function_name\n}",
    "providers_tf": "terraform {\n  required_version = \">= 1.0.0\"\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.0\"\n    }\n    archive = {\n      source  = \"hashicorp/archive\"\n      version = \"~> 2.0\"\n    }\n  }\n}\n\nprovider \"aws\" {\n  region = var.aws_region\n}"
  },
  "tags": ["serverless", "api-gateway", "lambda", "dynamodb", "rest-api"]
}

