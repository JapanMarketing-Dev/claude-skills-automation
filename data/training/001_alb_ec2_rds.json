{
  "id": "001_alb_ec2_rds",
  "source": "AWS Well-Architected Framework - Web Application",
  "request": "高可用性のWebアプリケーション基盤を構築したい。ALBで負荷分散し、EC2をAuto Scalingで2台以上配置、RDSはMulti-AZで冗長化してほしい。",
  "terraform_files": {
    "main_tf": "# VPC\nresource \"aws_vpc\" \"main\" {\n  cidr_block           = var.vpc_cidr\n  enable_dns_hostnames = true\n  enable_dns_support   = true\n\n  tags = {\n    Name = \"${var.project_name}-vpc\"\n  }\n}\n\n# Internet Gateway\nresource \"aws_internet_gateway\" \"main\" {\n  vpc_id = aws_vpc.main.id\n\n  tags = {\n    Name = \"${var.project_name}-igw\"\n  }\n}\n\n# Public Subnets\nresource \"aws_subnet\" \"public\" {\n  count                   = 2\n  vpc_id                  = aws_vpc.main.id\n  cidr_block              = cidrsubnet(var.vpc_cidr, 8, count.index)\n  availability_zone       = data.aws_availability_zones.available.names[count.index]\n  map_public_ip_on_launch = true\n\n  tags = {\n    Name = \"${var.project_name}-public-${count.index + 1}\"\n  }\n}\n\n# Private Subnets\nresource \"aws_subnet\" \"private\" {\n  count             = 2\n  vpc_id            = aws_vpc.main.id\n  cidr_block        = cidrsubnet(var.vpc_cidr, 8, count.index + 10)\n  availability_zone = data.aws_availability_zones.available.names[count.index]\n\n  tags = {\n    Name = \"${var.project_name}-private-${count.index + 1}\"\n  }\n}\n\n# NAT Gateway\nresource \"aws_eip\" \"nat\" {\n  domain = \"vpc\"\n\n  tags = {\n    Name = \"${var.project_name}-nat-eip\"\n  }\n}\n\nresource \"aws_nat_gateway\" \"main\" {\n  allocation_id = aws_eip.nat.id\n  subnet_id     = aws_subnet.public[0].id\n\n  tags = {\n    Name = \"${var.project_name}-nat\"\n  }\n}\n\n# Route Tables\nresource \"aws_route_table\" \"public\" {\n  vpc_id = aws_vpc.main.id\n\n  route {\n    cidr_block = \"0.0.0.0/0\"\n    gateway_id = aws_internet_gateway.main.id\n  }\n\n  tags = {\n    Name = \"${var.project_name}-public-rt\"\n  }\n}\n\nresource \"aws_route_table\" \"private\" {\n  vpc_id = aws_vpc.main.id\n\n  route {\n    cidr_block     = \"0.0.0.0/0\"\n    nat_gateway_id = aws_nat_gateway.main.id\n  }\n\n  tags = {\n    Name = \"${var.project_name}-private-rt\"\n  }\n}\n\nresource \"aws_route_table_association\" \"public\" {\n  count          = 2\n  subnet_id      = aws_subnet.public[count.index].id\n  route_table_id = aws_route_table.public.id\n}\n\nresource \"aws_route_table_association\" \"private\" {\n  count          = 2\n  subnet_id      = aws_subnet.private[count.index].id\n  route_table_id = aws_route_table.private.id\n}\n\n# Security Groups\nresource \"aws_security_group\" \"alb\" {\n  name        = \"${var.project_name}-alb-sg\"\n  description = \"Security group for ALB\"\n  vpc_id      = aws_vpc.main.id\n\n  ingress {\n    from_port   = 80\n    to_port     = 80\n    protocol    = \"tcp\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  ingress {\n    from_port   = 443\n    to_port     = 443\n    protocol    = \"tcp\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  egress {\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  tags = {\n    Name = \"${var.project_name}-alb-sg\"\n  }\n}\n\nresource \"aws_security_group\" \"ec2\" {\n  name        = \"${var.project_name}-ec2-sg\"\n  description = \"Security group for EC2\"\n  vpc_id      = aws_vpc.main.id\n\n  ingress {\n    from_port       = 80\n    to_port         = 80\n    protocol        = \"tcp\"\n    security_groups = [aws_security_group.alb.id]\n  }\n\n  egress {\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  tags = {\n    Name = \"${var.project_name}-ec2-sg\"\n  }\n}\n\nresource \"aws_security_group\" \"rds\" {\n  name        = \"${var.project_name}-rds-sg\"\n  description = \"Security group for RDS\"\n  vpc_id      = aws_vpc.main.id\n\n  ingress {\n    from_port       = 3306\n    to_port         = 3306\n    protocol        = \"tcp\"\n    security_groups = [aws_security_group.ec2.id]\n  }\n\n  egress {\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  tags = {\n    Name = \"${var.project_name}-rds-sg\"\n  }\n}\n\n# ALB\nresource \"aws_lb\" \"main\" {\n  name               = \"${var.project_name}-alb\"\n  internal           = false\n  load_balancer_type = \"application\"\n  security_groups    = [aws_security_group.alb.id]\n  subnets            = aws_subnet.public[*].id\n\n  tags = {\n    Name = \"${var.project_name}-alb\"\n  }\n}\n\nresource \"aws_lb_target_group\" \"main\" {\n  name     = \"${var.project_name}-tg\"\n  port     = 80\n  protocol = \"HTTP\"\n  vpc_id   = aws_vpc.main.id\n\n  health_check {\n    enabled             = true\n    healthy_threshold   = 2\n    interval            = 30\n    matcher             = \"200\"\n    path                = \"/\"\n    port                = \"traffic-port\"\n    protocol            = \"HTTP\"\n    timeout             = 5\n    unhealthy_threshold = 2\n  }\n\n  tags = {\n    Name = \"${var.project_name}-tg\"\n  }\n}\n\nresource \"aws_lb_listener\" \"http\" {\n  load_balancer_arn = aws_lb.main.arn\n  port              = 80\n  protocol          = \"HTTP\"\n\n  default_action {\n    type             = \"forward\"\n    target_group_arn = aws_lb_target_group.main.arn\n  }\n}\n\n# Launch Template\nresource \"aws_launch_template\" \"main\" {\n  name_prefix   = \"${var.project_name}-lt\"\n  image_id      = data.aws_ami.amazon_linux.id\n  instance_type = var.instance_type\n\n  network_interfaces {\n    associate_public_ip_address = false\n    security_groups             = [aws_security_group.ec2.id]\n  }\n\n  user_data = base64encode(<<-EOF\n    #!/bin/bash\n    yum update -y\n    yum install -y httpd\n    systemctl start httpd\n    systemctl enable httpd\n    echo \"Hello from $(hostname)\" > /var/www/html/index.html\n  EOF\n  )\n\n  tags = {\n    Name = \"${var.project_name}-lt\"\n  }\n}\n\n# Auto Scaling Group\nresource \"aws_autoscaling_group\" \"main\" {\n  name                = \"${var.project_name}-asg\"\n  desired_capacity    = var.desired_capacity\n  max_size            = var.max_size\n  min_size            = var.min_size\n  target_group_arns   = [aws_lb_target_group.main.arn]\n  vpc_zone_identifier = aws_subnet.private[*].id\n\n  launch_template {\n    id      = aws_launch_template.main.id\n    version = \"$Latest\"\n  }\n\n  tag {\n    key                 = \"Name\"\n    value               = \"${var.project_name}-ec2\"\n    propagate_at_launch = true\n  }\n}\n\n# RDS Subnet Group\nresource \"aws_db_subnet_group\" \"main\" {\n  name       = \"${var.project_name}-db-subnet\"\n  subnet_ids = aws_subnet.private[*].id\n\n  tags = {\n    Name = \"${var.project_name}-db-subnet\"\n  }\n}\n\n# RDS Instance\nresource \"aws_db_instance\" \"main\" {\n  identifier           = \"${var.project_name}-db\"\n  engine               = \"mysql\"\n  engine_version       = \"8.0\"\n  instance_class       = var.db_instance_class\n  allocated_storage    = 20\n  storage_type         = \"gp3\"\n  db_name              = var.db_name\n  username             = var.db_username\n  password             = var.db_password\n  multi_az             = true\n  db_subnet_group_name = aws_db_subnet_group.main.name\n  vpc_security_group_ids = [aws_security_group.rds.id]\n  skip_final_snapshot  = true\n\n  tags = {\n    Name = \"${var.project_name}-db\"\n  }\n}\n\n# Data Sources\ndata \"aws_availability_zones\" \"available\" {\n  state = \"available\"\n}\n\ndata \"aws_ami\" \"amazon_linux\" {\n  most_recent = true\n  owners      = [\"amazon\"]\n\n  filter {\n    name   = \"name\"\n    values = [\"al2023-ami-*-x86_64\"]\n  }\n}",
    "variables_tf": "variable \"aws_region\" {\n  description = \"AWS region\"\n  type        = string\n  default     = \"ap-northeast-1\"\n}\n\nvariable \"project_name\" {\n  description = \"Project name for resource naming\"\n  type        = string\n  default     = \"myapp\"\n}\n\nvariable \"vpc_cidr\" {\n  description = \"VPC CIDR block\"\n  type        = string\n  default     = \"10.0.0.0/16\"\n}\n\nvariable \"instance_type\" {\n  description = \"EC2 instance type\"\n  type        = string\n  default     = \"t3.micro\"\n}\n\nvariable \"desired_capacity\" {\n  description = \"Desired number of EC2 instances\"\n  type        = number\n  default     = 2\n}\n\nvariable \"min_size\" {\n  description = \"Minimum number of EC2 instances\"\n  type        = number\n  default     = 2\n}\n\nvariable \"max_size\" {\n  description = \"Maximum number of EC2 instances\"\n  type        = number\n  default     = 4\n}\n\nvariable \"db_instance_class\" {\n  description = \"RDS instance class\"\n  type        = string\n  default     = \"db.t3.micro\"\n}\n\nvariable \"db_name\" {\n  description = \"Database name\"\n  type        = string\n  default     = \"myappdb\"\n}\n\nvariable \"db_username\" {\n  description = \"Database username\"\n  type        = string\n  default     = \"admin\"\n}\n\nvariable \"db_password\" {\n  description = \"Database password\"\n  type        = string\n  sensitive   = true\n}",
    "outputs_tf": "output \"alb_dns_name\" {\n  description = \"ALB DNS name\"\n  value       = aws_lb.main.dns_name\n}\n\noutput \"rds_endpoint\" {\n  description = \"RDS endpoint\"\n  value       = aws_db_instance.main.endpoint\n}\n\noutput \"vpc_id\" {\n  description = \"VPC ID\"\n  value       = aws_vpc.main.id\n}",
    "providers_tf": "terraform {\n  required_version = \">= 1.0.0\"\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.0\"\n    }\n  }\n}\n\nprovider \"aws\" {\n  region = var.aws_region\n}"
  },
  "tags": ["alb", "ec2", "auto-scaling", "rds", "multi-az", "high-availability", "web-application"]
}

