{
  "id": "003_ecs_fargate",
  "source": "AWS Reference Architecture - Container",
  "request": "ECS Fargateでコンテナアプリを動かしたい。ALBで外部公開し、ECRからイメージを取得する構成で。",
  "terraform_files": {
    "main_tf": "# VPC\nresource \"aws_vpc\" \"main\" {\n  cidr_block           = var.vpc_cidr\n  enable_dns_hostnames = true\n  enable_dns_support   = true\n\n  tags = {\n    Name = \"${var.project_name}-vpc\"\n  }\n}\n\nresource \"aws_internet_gateway\" \"main\" {\n  vpc_id = aws_vpc.main.id\n\n  tags = {\n    Name = \"${var.project_name}-igw\"\n  }\n}\n\nresource \"aws_subnet\" \"public\" {\n  count                   = 2\n  vpc_id                  = aws_vpc.main.id\n  cidr_block              = cidrsubnet(var.vpc_cidr, 8, count.index)\n  availability_zone       = data.aws_availability_zones.available.names[count.index]\n  map_public_ip_on_launch = true\n\n  tags = {\n    Name = \"${var.project_name}-public-${count.index + 1}\"\n  }\n}\n\nresource \"aws_subnet\" \"private\" {\n  count             = 2\n  vpc_id            = aws_vpc.main.id\n  cidr_block        = cidrsubnet(var.vpc_cidr, 8, count.index + 10)\n  availability_zone = data.aws_availability_zones.available.names[count.index]\n\n  tags = {\n    Name = \"${var.project_name}-private-${count.index + 1}\"\n  }\n}\n\nresource \"aws_eip\" \"nat\" {\n  domain = \"vpc\"\n\n  tags = {\n    Name = \"${var.project_name}-nat-eip\"\n  }\n}\n\nresource \"aws_nat_gateway\" \"main\" {\n  allocation_id = aws_eip.nat.id\n  subnet_id     = aws_subnet.public[0].id\n\n  tags = {\n    Name = \"${var.project_name}-nat\"\n  }\n}\n\nresource \"aws_route_table\" \"public\" {\n  vpc_id = aws_vpc.main.id\n\n  route {\n    cidr_block = \"0.0.0.0/0\"\n    gateway_id = aws_internet_gateway.main.id\n  }\n\n  tags = {\n    Name = \"${var.project_name}-public-rt\"\n  }\n}\n\nresource \"aws_route_table\" \"private\" {\n  vpc_id = aws_vpc.main.id\n\n  route {\n    cidr_block     = \"0.0.0.0/0\"\n    nat_gateway_id = aws_nat_gateway.main.id\n  }\n\n  tags = {\n    Name = \"${var.project_name}-private-rt\"\n  }\n}\n\nresource \"aws_route_table_association\" \"public\" {\n  count          = 2\n  subnet_id      = aws_subnet.public[count.index].id\n  route_table_id = aws_route_table.public.id\n}\n\nresource \"aws_route_table_association\" \"private\" {\n  count          = 2\n  subnet_id      = aws_subnet.private[count.index].id\n  route_table_id = aws_route_table.private.id\n}\n\n# Security Groups\nresource \"aws_security_group\" \"alb\" {\n  name        = \"${var.project_name}-alb-sg\"\n  description = \"Security group for ALB\"\n  vpc_id      = aws_vpc.main.id\n\n  ingress {\n    from_port   = 80\n    to_port     = 80\n    protocol    = \"tcp\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  egress {\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  tags = {\n    Name = \"${var.project_name}-alb-sg\"\n  }\n}\n\nresource \"aws_security_group\" \"ecs\" {\n  name        = \"${var.project_name}-ecs-sg\"\n  description = \"Security group for ECS tasks\"\n  vpc_id      = aws_vpc.main.id\n\n  ingress {\n    from_port       = var.container_port\n    to_port         = var.container_port\n    protocol        = \"tcp\"\n    security_groups = [aws_security_group.alb.id]\n  }\n\n  egress {\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  tags = {\n    Name = \"${var.project_name}-ecs-sg\"\n  }\n}\n\n# ECR Repository\nresource \"aws_ecr_repository\" \"main\" {\n  name                 = var.project_name\n  image_tag_mutability = \"MUTABLE\"\n\n  image_scanning_configuration {\n    scan_on_push = true\n  }\n\n  tags = {\n    Name = \"${var.project_name}-ecr\"\n  }\n}\n\n# ECS Cluster\nresource \"aws_ecs_cluster\" \"main\" {\n  name = \"${var.project_name}-cluster\"\n\n  setting {\n    name  = \"containerInsights\"\n    value = \"enabled\"\n  }\n\n  tags = {\n    Name = \"${var.project_name}-cluster\"\n  }\n}\n\n# ECS Task Execution Role\nresource \"aws_iam_role\" \"ecs_execution\" {\n  name = \"${var.project_name}-ecs-execution-role\"\n\n  assume_role_policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Action = \"sts:AssumeRole\"\n        Effect = \"Allow\"\n        Principal = {\n          Service = \"ecs-tasks.amazonaws.com\"\n        }\n      }\n    ]\n  })\n\n  tags = {\n    Name = \"${var.project_name}-ecs-execution-role\"\n  }\n}\n\nresource \"aws_iam_role_policy_attachment\" \"ecs_execution\" {\n  role       = aws_iam_role.ecs_execution.name\n  policy_arn = \"arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy\"\n}\n\n# ECS Task Role\nresource \"aws_iam_role\" \"ecs_task\" {\n  name = \"${var.project_name}-ecs-task-role\"\n\n  assume_role_policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Action = \"sts:AssumeRole\"\n        Effect = \"Allow\"\n        Principal = {\n          Service = \"ecs-tasks.amazonaws.com\"\n        }\n      }\n    ]\n  })\n\n  tags = {\n    Name = \"${var.project_name}-ecs-task-role\"\n  }\n}\n\n# CloudWatch Log Group\nresource \"aws_cloudwatch_log_group\" \"ecs\" {\n  name              = \"/ecs/${var.project_name}\"\n  retention_in_days = 14\n\n  tags = {\n    Name = \"${var.project_name}-ecs-logs\"\n  }\n}\n\n# ECS Task Definition\nresource \"aws_ecs_task_definition\" \"main\" {\n  family                   = var.project_name\n  network_mode             = \"awsvpc\"\n  requires_compatibilities = [\"FARGATE\"]\n  cpu                      = var.task_cpu\n  memory                   = var.task_memory\n  execution_role_arn       = aws_iam_role.ecs_execution.arn\n  task_role_arn            = aws_iam_role.ecs_task.arn\n\n  container_definitions = jsonencode([\n    {\n      name      = var.project_name\n      image     = \"${aws_ecr_repository.main.repository_url}:latest\"\n      essential = true\n      portMappings = [\n        {\n          containerPort = var.container_port\n          protocol      = \"tcp\"\n        }\n      ]\n      logConfiguration = {\n        logDriver = \"awslogs\"\n        options = {\n          \"awslogs-group\"         = aws_cloudwatch_log_group.ecs.name\n          \"awslogs-region\"        = var.aws_region\n          \"awslogs-stream-prefix\" = \"ecs\"\n        }\n      }\n    }\n  ])\n\n  tags = {\n    Name = \"${var.project_name}-task\"\n  }\n}\n\n# ALB\nresource \"aws_lb\" \"main\" {\n  name               = \"${var.project_name}-alb\"\n  internal           = false\n  load_balancer_type = \"application\"\n  security_groups    = [aws_security_group.alb.id]\n  subnets            = aws_subnet.public[*].id\n\n  tags = {\n    Name = \"${var.project_name}-alb\"\n  }\n}\n\nresource \"aws_lb_target_group\" \"main\" {\n  name        = \"${var.project_name}-tg\"\n  port        = var.container_port\n  protocol    = \"HTTP\"\n  vpc_id      = aws_vpc.main.id\n  target_type = \"ip\"\n\n  health_check {\n    enabled             = true\n    healthy_threshold   = 2\n    interval            = 30\n    matcher             = \"200\"\n    path                = \"/\"\n    port                = \"traffic-port\"\n    protocol            = \"HTTP\"\n    timeout             = 5\n    unhealthy_threshold = 2\n  }\n\n  tags = {\n    Name = \"${var.project_name}-tg\"\n  }\n}\n\nresource \"aws_lb_listener\" \"http\" {\n  load_balancer_arn = aws_lb.main.arn\n  port              = 80\n  protocol          = \"HTTP\"\n\n  default_action {\n    type             = \"forward\"\n    target_group_arn = aws_lb_target_group.main.arn\n  }\n}\n\n# ECS Service\nresource \"aws_ecs_service\" \"main\" {\n  name            = \"${var.project_name}-service\"\n  cluster         = aws_ecs_cluster.main.id\n  task_definition = aws_ecs_task_definition.main.arn\n  desired_count   = var.desired_count\n  launch_type     = \"FARGATE\"\n\n  network_configuration {\n    subnets          = aws_subnet.private[*].id\n    security_groups  = [aws_security_group.ecs.id]\n    assign_public_ip = false\n  }\n\n  load_balancer {\n    target_group_arn = aws_lb_target_group.main.arn\n    container_name   = var.project_name\n    container_port   = var.container_port\n  }\n\n  depends_on = [aws_lb_listener.http]\n\n  tags = {\n    Name = \"${var.project_name}-service\"\n  }\n}\n\n# Data Sources\ndata \"aws_availability_zones\" \"available\" {\n  state = \"available\"\n}",
    "variables_tf": "variable \"aws_region\" {\n  description = \"AWS region\"\n  type        = string\n  default     = \"ap-northeast-1\"\n}\n\nvariable \"project_name\" {\n  description = \"Project name for resource naming\"\n  type        = string\n  default     = \"ecs-app\"\n}\n\nvariable \"vpc_cidr\" {\n  description = \"VPC CIDR block\"\n  type        = string\n  default     = \"10.0.0.0/16\"\n}\n\nvariable \"container_port\" {\n  description = \"Container port\"\n  type        = number\n  default     = 80\n}\n\nvariable \"task_cpu\" {\n  description = \"Task CPU units\"\n  type        = string\n  default     = \"256\"\n}\n\nvariable \"task_memory\" {\n  description = \"Task memory in MB\"\n  type        = string\n  default     = \"512\"\n}\n\nvariable \"desired_count\" {\n  description = \"Desired number of tasks\"\n  type        = number\n  default     = 2\n}",
    "outputs_tf": "output \"alb_dns_name\" {\n  description = \"ALB DNS name\"\n  value       = aws_lb.main.dns_name\n}\n\noutput \"ecr_repository_url\" {\n  description = \"ECR repository URL\"\n  value       = aws_ecr_repository.main.repository_url\n}\n\noutput \"ecs_cluster_name\" {\n  description = \"ECS cluster name\"\n  value       = aws_ecs_cluster.main.name\n}\n\noutput \"ecs_service_name\" {\n  description = \"ECS service name\"\n  value       = aws_ecs_service.main.name\n}",
    "providers_tf": "terraform {\n  required_version = \">= 1.0.0\"\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.0\"\n    }\n  }\n}\n\nprovider \"aws\" {\n  region = var.aws_region\n}"
  },
  "tags": ["ecs", "fargate", "container", "alb", "ecr", "docker"]
}

